# ADR.004

Переход с PostreSQL на MongoDB в качестве основной БД проекта

<!-- Название ADR состоит из [ADR.###] [Коротко суть принятого решения] -->

* Статус: Предложено
* Владелец: superteamlead@mts.ru

## Контекст
<!-- Описание проблемы, требующей решения, причин, побудивших принять решение, ограничений, действовавших на момент принятия решения -->
С учетом расширения предметной области системы и появления многих новых сущностей и сценариев использования - 
необходимо проанализировать преимущества и недостатки варианта перехода на MongoDB в качестве основного хранилища.

## Сравнение вариантов решения
<!-- Описание рассмотренных вариантов c их плюсами и минусами -->

Рассмотрим разницу между данными СУБД применительно к особенностям задачи.

### Гибкость изменения модели

**Обоснование**: в рамках этапа эволюции системы предполагается добавление большого количества новой функциональности и существенно расширение модели данных.

**PostgreSQL**: предполагает наличие жесткой схемы данных. Любое изменение в модели требует изменений в схеме БД и, возможно, миграцию данных.

**MongoDB**: документ коллекции может иметь произвольную структуру. Изменения модели документы не требуют подстройки схемы по причине ее отсутствия. Добавление новых типов документов (коллекций) максимально упрощено. ***1 балл***

### Отказоустойчивость и горизонтальное масштабирование

**Обоснование**: Отказоустойчивость - обяазательная вещь, так как система предполагается с высоким уровнем доступности в 99.5% и временем работы 24/7.

**PostgreSQL**: Возможен режим master/slave с балансировщиком, в таком случае операции чтения могут быть ускорены. На операции записи это эффекта не оказывает. ***1 балл***

**MongoDB**: Поддержка Replica Set и Sharding. Поддержка шардирования является заметным плюсом MongoDB, но на данный момент оценка объемов разных типов данных, входящих в доменную модель - позволяет уверенно предположить, что данная функция не будет востребована в обозримой перспективе.  ***1 балл***

### Поддержка транзакций ACID 

**Обоснование**: Часть бизнес функций предполагает внесение изменений в сразу несколько бизнес сущностей, поддержка транзакций на уровне СУБД позволяет упростить написание бизнес-логики (без ручного написание компенсирующих транзакций)

**PostgreSQL**: Полноценная поддержка. ***1 балл***

**MongoDB**: В новых версия поддерживаются транзакции между разными коллекциями и на несколько документов. ***1 балл***

### Поддержка ограничений уровня данных 

**Обоснование**: В рамках данного проекта поддержка ограничений в БД может помочь ускорить процесс написания сервисного слоя бизнес-логики. 

**PostgreSQL**: Поддержка ссылочной целостности, поддержка других ограничений. ***1 балл***

**MongoDB**: Поддержка уникальных индексов, базовая поддержка других ограничений - но общее правило использования нереляционной БД рекомендует размещать данные проверки в слое бизнес логики.

### Поддержка аналитических запросов 

**Обоснование**: Среди бизнес-сценариев использования существенную роль играют кейсы построения различной отчетности. Наличие в БД инструментов получения аналитики - является требованием.

**PostgreSQL**: Поддержка аналитических запросов любой сложности (в рамках возможностей современнной реляционной БД). ***1 балл***

**MongoDB**: Базовая поддержка аналитических запросов.

### Лицензионная политика 

**Обоснование**: переход на другую СУБД может подразумевать дополнительные расходы и увеличение бюджета проекта.

**PostgreSQL**: Необходимые ресурсы уже присутствуют. ***1 балл***

**MongoDB**: Основное функционал доступен в Community версии, но требуется настройка и создание сервиса со стороны Devops-команды.

### Зрелость команды относительно технологии

**Обоснование**: Наличие релевантного опыта позволяет с большей точностью прогнозировать объем выполняемых работ

**PostgreSQL**: Команда работает с данной СУБД достаточно давно в рамках проекта, а также имеет успешный опыт в предыдущих проектах. ***1 балл***

**MongoDB**: Команда имеет базовый уровень представления о СУБД MongoDB. Ни у кого из членов команды нет успешного опыта участия в коммерческой разработки с данной технологией. Сроки разработки могут быть увеличены при переходе на данную БД.


## Решение
<!-- Описание выбранного решения. Решение должно быть сформулировано чётко ("Мы используем...", "Мы не используем", а не "Желательно.." или "Предлагается..."). 
Должна быть понятна связь между решением и проблемой, почему выбрали именно это решение из вариантов -->

Итого набрано баллов: 
**PostgreSQL**: 6
**MongoDB**: 3

В рамках проекта helloconf предлагается и далее использовать реляционную СУБД PostgreSQL - так как среди критериев сравнения только гибкость в подходе к изменениям модели является заметным преимуществом MongoDB. Это может привести к уменьшению затрат в разработке, но сам переход на новую для команды БД их в свою очередь может увеличить. По остальным критериям не выявлено существнных преимуществ в варианте перехода на MongoDB. 

## Последствия
<!-- Положительные и отрицательные последствия (trade-offs). Арх. решения, которые потребуется принять как следствие принятого решения. Если решение содержит риски, то описано, как с ними планируют поступить (за счет чего снижать, почему принять). -->

При резком росте объема данных может потребоваться применять Шардирование - которое является существенным преимуществом MongoDB. Для команды рекомендуется не использования тяжелую бизнес логику стороны СУБД (триггеры и хранимые процедуры).
Другая рекомендация включает в себя поддержку достаточного уровня абстрагирования от природы СУБД при написании слоя доступа к данным. Это поможет упростить миграцию на другую СУБД, если она потребуется из-за резкого роста объема БД и потребности в построении полноценного кластера.